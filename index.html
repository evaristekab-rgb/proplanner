<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pro Planner — Reminders + ICS</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0b10"/>
  <style>
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b0b10;color:#eaeaf2}
    header{position:sticky;top:0;z-index:20;background:#0b0b10aa;border-bottom:1px solid #2c2c3d;backdrop-filter:blur(8px);}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,input,button{background:#141420;border:1px solid #2c2c3d;color:#eaeaf2;padding:8px 10px;border-radius:10px}
    button{box-shadow:0 10px 20px rgba(0,0,0,.35)}
    .badge{background:#232336;color:#d7d7e2;border:1px solid #2c2c3d;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tabs button{border-radius:999px}
    .tabs .active{background:#6ea8fe;border-color:#568fe2}
    main .wrap{padding-top:10px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:#141420;border:1px solid #2c2c3d;border-radius:14px;padding:12px}
    .kpi .label{color:#a3a3b2;font-size:12px}
    .kpi .value{font-size:26px;font-weight:800}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{color:#a3a3b2;text-align:center;font-weight:600}
    .day{background:#141420;border:1px solid #2c2c3d;border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .day.out{opacity:.45}
    .day .head{display:flex;justify-content:space-between;align-items:center}
    .chip{background:#232336;color:#d7d7e2;border:1px solid #2c2c3d;border-radius:999px;padding:2px 8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip.done{background:#2d6a4f;color:#fff;border-color:#23563f}
    .chip.overdue{background:#b91c1c;color:#fff;border-color:#8a1515}
    dialog{width:min(820px,95vw);border:1px solid #2c2c3d;border-radius:14px;padding:0;background:#141420;color:#eaeaf2}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #2c2c3d}
    .modal-b{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
    .modal-b textarea{grid-column:1/-1;min-height:80px}
    .modal-f{display:flex;justify-content:space-between;border-top:1px solid #2c2c3d;padding:12px}
    @media(max-width:900px){.grid4{grid-template-columns:1fr 1fr}.modal-b{grid-template-columns:1fr}}
    @media(max-width:640px){.calendar{grid-template-columns:1fr 1fr}.grid4{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <strong>Pro Planner</strong><span class="badge">Reminders + ICS</span>
        <span style="flex:1"></span>
        <select id="month"></select>
        <select id="year"></select>
        <button id="addBtn">+ Task</button>
        <button id="importBtn">Import</button>
        <button id="exportBtn">Export JSON</button>
        <button id="icsBtn">Export ICS (month)</button>
      </div>
      <div class="tabs">
        <button class="active" data-tab="month">Month</button>
        <button data-tab="list">List</button>
        <button data-tab="help">Help</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <section class="grid4">
        <div class="card kpi"><div class="label">Planned (tasks)</div><div class="value" id="k1">0</div></div>
        <div class="card kpi"><div class="label">Completed (tasks)</div><div class="value" id="k2">0</div></div>
        <div class="card kpi"><div class="label">Completion %</div><div class="value" id="k3">0%</div></div>
        <div class="card kpi"><div class="label">Planned / Actual Hours</div><div class="value" id="k4">0 / 0</div></div>
      </section>

      <section id="tab-month">
        <div class="calendar" id="dow"></div>
        <div class="calendar" id="cal"></div>
      </section>

      <section id="tab-list" hidden>
        <div class="card">
          <div class="row" style="margin-bottom:8px">
            <input id="q" placeholder="Search title/tags/notes" style="flex:1"/>
            <select id="fltStatus"><option value="">All Status</option></select>
            <select id="fltCat"><option value="">All Categories</option></select>
          </div>
          <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
            <thead><tr>
              <th style="text-align:left;color:#a3a3b2">Due</th>
              <th style="text-align:left;color:#a3a3b2">Task</th>
              <th style="text-align:left;color:#a3a3b2">Status</th>
              <th style="text-align:left;color:#a3a3b2">Planned</th>
              <th style="text-align:left;color:#a3a3b2">Actual</th>
              <th></th>
            </tr></thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>

      <section id="tab-help" hidden>
        <div class="card">
          <h3 style="margin:4px 0 8px">Reminders: two reliable ways</h3>
          <ol>
            <li><b>Local notifications (in‑app):</b> Turn on <em>Enable reminders</em> in the task. Your browser will show a notification at the scheduled time <i>while the app is open</i>.</li>
            <li><b>Calendar export (.ics):</b> Click <em>Export ICS</em> and open the file in your Calendar app (iOS/Android/Outlook/Google). Each task includes a <em>10‑minute before</em> alert (adjust per task).</li>
          </ol>
          <p>For cross‑device sync, host this folder and install as a PWA, or use the earlier GitHub Pages steps.</p>
        </div>
      </section>
    </div>
  </main>

  <dialog id="dlg">
    <form method="dialog" id="form">
      <div class="modal-h">
        <strong id="dlgTitle">Add Task</strong>
        <button type="button" id="x">✕</button>
      </div>
      <div class="modal-b">
        <div><label>Task</label><input id="f_title" required></div>
        <div><label>Category</label><select id="f_cat"><option>Work</option><option>Personal</option><option>Health</option><option>Learning</option><option>Finance</option><option>Admin</option><option>Other</option></select></div>
        <div><label>Status</label><select id="f_status"><option>Not Started</option><option>In Progress</option><option>Done</option><option>Deferred</option><option>Cancelled</option></select></div>
        <div><label>Due Date</label><input id="f_due" type="date" required></div>
        <div><label>Planned Hours</label><input id="f_ph" type="number" min="0" step="0.25"></div>
        <div><label>Actual Hours</label><input id="f_ah" type="number" min="0" step="0.25"></div>
        <div><label>Reminder</label>
          <select id="f_rem">
            <option value="none">None</option>
            <option value="at">At specific time</option>
            <option value="mins">Minutes before due</option>
          </select>
        </div>
        <div><label>Reminder time (if "At")</label><input id="f_rem_at" type="datetime-local"></div>
        <div><label>Minutes before due (if "Minutes")</label><input id="f_rem_mins" type="number" min="1" step="1" placeholder="10"></div>
        <div style="grid-column:1/-1"><label>Notes</label><textarea id="f_notes" placeholder="Context"></textarea></div>
      </div>
      <div class="modal-f">
        <button type="button" id="del" style="background:#b91c1c;border-color:#8a1515;color:#fff;display:none">Delete</button>
        <div>
          <button value="cancel">Cancel</button>
          <button value="default" style="background:#6ea8fe;border-color:#568fe2;color:#fff">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <input type="file" id="picker" accept=".json" hidden/>

  <script>
    const STORAGE = "proplanner.tasks.v2"; // keep compatibility with your existing data
    let tasks = load();
    const months = Array.from({length:12},(_,i)=>({n:i+1,name:new Date(2000,i,1).toLocaleString(undefined,{month:'long'})}));
    const years = Array.from({length:11},(_,i)=> new Date().getFullYear()-2 + i);

    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    // Build month/year selectors
    months.forEach(m=> $("#month").append(new Option(`${String(m.n).padStart(2,'0')} — ${m.name}`, m.n)));
    years.forEach(y=> $("#year").append(new Option(y, y)));
    const now = new Date(); $("#month").value = String(now.getMonth()+1); $("#year").value = String(now.getFullYear());

    // Tabs
    $$(".tabs button").forEach(b=> b.addEventListener("click", ()=>{ $$(".tabs button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); showTab(b.dataset.tab);}));
    function showTab(id){ $("#tab-month").hidden = id!=="month"; $("#tab-list").hidden = id!=="list"; $("#tab-help").hidden = id!=="help"; }

    // Data helpers
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE) || "[]"); }catch{ return [] } }
    function save(){ localStorage.setItem(STORAGE, JSON.stringify(tasks)); scheduleUpcomingReminders(); }
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function toYMD(d){ if(!d) return ""; const z = new Date(d); return `${z.getFullYear()}-${String(z.getMonth()+1).padStart(2,'0')}-${String(z.getDate()).padStart(2,'0')}`; }
    function fromYMD(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
    function addDays(d,n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

    // KPI + Month view
    $("#month").addEventListener("change", renderAll);
    $("#year").addEventListener("change", renderAll);

    function tasksForMonth(y,m){ return tasks.filter(t=>{ const d = fromYMD(t.dueDate); return d && d.getFullYear()==y && (d.getMonth()+1)==m; }); }
    function renderKPIs(){
      const y = +$("#year").value, m = +$("#month").value;
      const arr = tasksForMonth(y,m);
      $("#k1").textContent = arr.length;
      const done = arr.filter(t=>t.status==="Done").length;
      $("#k2").textContent = done;
      $("#k3").textContent = (arr.length ? Math.round(done/arr.length*100) : 0) + "%";
      const ph = arr.reduce((a,t)=>a+(+t.planned||0),0).toFixed(1);
      const ah = arr.reduce((a,t)=>a+(+t.actual||0),0).toFixed(1);
      $("#k4").textContent = `${ph} / ${ah}`;
    }

    function renderMonth(){
      const y = +$("#year").value, m = +$("#month").value;
      const cal = $("#cal"); cal.innerHTML = ""; $("#dow").innerHTML = "";
      ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(d=>{ const el = document.createElement("div"); el.textContent=d; el.className="dow"; $("#dow").appendChild(el); });
      const first = new Date(y,m-1,1); const wd = (first.getDay()+6)%7; const start = addDays(first,-wd);
      const today = toYMD(new Date());
      for(let i=0;i<42;i++){
        const d = addDays(start,i), inM = (d.getMonth()+1)==m;
        const cell = document.createElement("div"); cell.className="day"+(inM?"":" out");
        const head = document.createElement("div"); head.className="head";
        const num = document.createElement("div"); num.textContent = d.getDate(); if(toYMD(d)===today) num.style.color="#6ea8fe";
        const btn = document.createElement("button"); btn.textContent="+"; btn.addEventListener("click", (e)=>{ e.stopPropagation(); openDlg({dueDate:toYMD(d)}); });
        head.append(num, btn);
        const list = document.createElement("div");
        tasks.filter(t=>t.dueDate===toYMD(d)).slice(0,3).forEach(t=>{
          const chip = document.createElement("div"); chip.className="chip "+(t.status==="Done"?"done": (fromYMD(t.dueDate) < new Date(new Date().toDateString()) ? "overdue": ""));
          chip.textContent = t.title; chip.title = t.title; chip.addEventListener("click", ()=> openDlg(t));
          list.appendChild(chip);
        });
        cell.append(head,list); cell.addEventListener("click",()=> openDlg({dueDate:toYMD(d)})); cal.appendChild(cell);
      }
    }

    // List view
    const STAT = ["Not Started","In Progress","Done","Deferred","Cancelled"];
    const CATS = ["Work","Personal","Health","Learning","Finance","Admin","Other"];
    STAT.forEach(s=> $("#fltStatus").append(new Option(s,s)));
    CATS.forEach(s=> $("#fltCat").append(new Option(s,s)));
    $("#q").addEventListener("input", renderList);
    $("#fltStatus").addEventListener("change", renderList);
    $("#fltCat").addEventListener("change", renderList);

    function renderList(){
      const y = +$("#year").value, m = +$("#month").value;
      const rows = $("#rows"); rows.innerHTML="";
      const q = ($("#q").value||"").toLowerCase(), fs=$("#fltStatus").value, fc=$("#fltCat").value;
      const arr = tasksForMonth(y,m).filter(t=>{
        const txt = (t.title+" "+(t.notes||"")).toLowerCase();
        const okQ = !q || txt.includes(q);
        const okS = !fs || t.status===fs;
        const okC = !fc || t.category===fc;
        return okQ && okS && okC;
      }).sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
      for(const t of arr){
        const tr = document.createElement("tr"); tr.style.background="#141420"; tr.style.border="1px solid #2c2c3d"; tr.style.borderRadius="12px";
        tr.innerHTML = `
          <td style="padding:8px">${t.dueDate||""}</td>
          <td style="padding:8px">${escape(t.title||"")}</td>
          <td style="padding:8px">${t.status||""}</td>
          <td style="padding:8px">${t.planned||""}</td>
          <td style="padding:8px">${t.actual||""}</td>
          <td style="padding:8px;text-align:right"><button data-id="${t.id}">Edit</button></td>`;
        tr.querySelector("button").addEventListener("click", ()=> openDlg(t));
        rows.appendChild(tr);
      }
    }

    // Modal
    const dlg = $("#dlg"); $("#x").addEventListener("click", ()=> dlg.close());
    let editing = null;
    function openDlg(obj={}){
      editing = obj.id || null; $("#dlgTitle").textContent = editing ? "Edit Task" : "Add Task";
      $("#del").style.display = editing ? "inline-block" : "none";
      $("#f_title").value = obj.title||"";
      $("#f_cat").value = obj.category||"Work";
      $("#f_status").value = obj.status||"Not Started";
      $("#f_due").value = obj.dueDate||"";
      $("#f_ph").value = obj.planned||"";
      $("#f_ah").value = obj.actual||"";
      $("#f_notes").value = obj.notes||"";
      $("#f_rem").value = obj.remType||"none";
      $("#f_rem_at").value = obj.remAt||"";
      $("#f_rem_mins").value = obj.remMins||"";
      dlg.showModal();
    }
    $("#del").addEventListener("click", ()=>{ if(!editing) return; tasks = tasks.filter(t=>t.id!==editing); save(); dlg.close(); renderAll(); });
    $("#form").addEventListener("close", ()=>{});
    $("#form").addEventListener("submit", (e)=>{
      e.preventDefault();
      const obj = {
        id: editing || uid(),
        title: $("#f_title").value.trim(),
        category: $("#f_cat").value,
        status: $("#f_status").value,
        dueDate: $("#f_due").value,
        planned: Number($("#f_ph").value)||0,
        actual: Number($("#f_ah").value)||0,
        notes: $("#f_notes").value||"",
        remType: $("#f_rem").value,
        remAt: $("#f_rem_at").value,
        remMins: Number($("#f_rem_mins").value)||0
      };
      if(!obj.title || !obj.dueDate){ alert("Enter task and due date"); return; }
      const i = tasks.findIndex(t=>t.id===obj.id);
      if(i>=0) tasks[i]=obj; else tasks.push(obj);
      save(); dlg.close(); renderAll();
    });

    // Import/Export
    $("#importBtn").addEventListener("click", ()=> $("#picker").click());
    $("#picker").addEventListener("change", async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{ const txt = await f.text(); const arr = JSON.parse(txt); if(!Array.isArray(arr)) throw 0; tasks = arr; save(); renderAll(); alert("Imported "+tasks.length+" tasks"); }catch{ alert("Invalid JSON"); }
      e.target.value="";
    });
    $("#exportBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(tasks,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="proplanner_tasks.json"; a.click(); URL.revokeObjectURL(url);
    });

    // ICS export (month)
    $("#icsBtn").addEventListener("click", ()=>{
      const y=+$("#year").value, m=+$("#month").value; const arr = tasksForMonth(y,m);
      if(!arr.length){ alert("No tasks in selected month."); return; }
      const lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//ProPlanner//EN"];
      for(const t of arr){
        const dt = fromYMD(t.dueDate);
        const dtstart = fmtICS(dt, "090000"); // start 9am by default
        const dtend = fmtICS(dt, "100000");   // 1h block
        const uidv = t.id + "@proplanner";
        lines.push("BEGIN:VEVENT");
        lines.push("UID:"+uidv);
        lines.push("DTSTAMP:"+fmtNow());
        lines.push("SUMMARY:"+icsEscape(t.title||"Task"));
        lines.push("DESCRIPTION:"+icsEscape((t.notes||"") + (t.planned? "\\nPlanned: "+t.planned+"h": "") + (t.actual? "\\nActual: "+t.actual+"h": "")));
        lines.push("DTSTART:"+dtstart);
        lines.push("DTEND:"+dtend);
        // Alarm
        let trigger = "-PT10M";
        if(t.remType==="mins" && t.remMins>0){ trigger = "-PT"+t.remMins+"M"; }
        lines.push("BEGIN:VALARM"); lines.push("TRIGGER:"+trigger); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM");
        // Specific time reminder as separate event start if provided
        if(t.remType==="at" && t.remAt){
          lines.push("BEGIN:VALARM"); lines.push("TRIGGER;VALUE=DATE-TIME:"+fmtICS(new Date(t.remAt))); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM");
        }
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      const blob = new Blob([lines.join("\r\n")],{type:"text/calendar"});
      const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`proplanner_${y}-${String(m).padStart(2,"0")}.ics`; a.click(); URL.revokeObjectURL(url);
    });
    function icsEscape(s){ return String(s||"").replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n"); }
    function fmtNow(){ const d=new Date(); return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+"Z"; }
    function fmtICS(d, timeHHMMSS){ const z = new Date(d); if(timeHHMMSS){ return z.getFullYear()+pad(z.getMonth()+1)+pad(z.getDate())+"T"+timeHHMMSS; } return z.getFullYear()+pad(z.getMonth()+1)+pad(z.getDate())+"T"+pad(z.getHours())+pad(z.getMinutes())+pad(z.getSeconds()); }
    function pad(n){ return String(n).padStart(2,"0") }

    // Local notifications (while app is open)
    let timers = [];
    async function ensureNotifPerm(){ if(!("Notification" in window)) return false; if(Notification.permission==="granted") return true; if(Notification.permission==="denied") return false; const res = await Notification.requestPermission(); return res==="granted"; }
    function scheduleUpcomingReminders(){
      // Clear old timers
      timers.forEach(t=>clearTimeout(t)); timers=[];
      // Only schedule when app is open; take next 24h
      const now = Date.now(); const horizon = now + 24*60*60*1000;
      tasks.forEach(t=>{
        let when = null;
        if(t.remType==="at" && t.remAt){ when = new Date(t.remAt).getTime(); }
        else if(t.remType==="mins" && t.remMins>0 && t.dueDate){ when = fromYMD(t.dueDate).getTime() - t.remMins*60*1000; }
        if(when && when>now && when<horizon){
          const delay = when - now;
          timers.push(setTimeout(async ()=>{
            if(await ensureNotifPerm()){ new Notification("Upcoming: "+t.title, { body: (t.dueDate||"") + (t.planned? " • Planned "+t.planned+"h":""), badge:"./icon-192.png", icon:"./icon-192.png" }); }
          }, delay));
        }
      });
    }

    // Render all
    function renderAll(){ renderKPIs(); renderMonth(); renderList(); scheduleUpcomingReminders(); }
    function escape(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

    // Init
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
    renderAll();
    scheduleUpcomingReminders();
  </script>
</body>
</html>