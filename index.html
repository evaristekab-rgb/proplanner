<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Planner â€” Professional + Reminders</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0b10"/>
  <style>
    :root{
      --bg:#0b0b10; --panel:#141420; --muted:#a3a3b2; --text:#eaeaf2;
      --accent:#6ea8fe; --accent-2:#7bd389; --danger:#ff6b6b; --warn:#f6c453;
      --border:#2c2c3d; --chip:#232336; --chip-text:#d7d7e2;
      --shadow:0 10px 20px rgba(0,0,0,.35), 0 6px 6px rgba(0,0,0,.28);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f6fb; --panel:#ffffff; --muted:#646b78; --text:#0f1220;
        --accent:#1f6feb; --accent-2:#16a34a; --danger:#dc2626; --warn:#b45309;
        --border:#e5e7eb; --chip:#f3f4f6; --chip-text:#111827;
        --shadow:0 10px 18px rgba(17,24,39,.08), 0 6px 6px rgba(17,24,39,.06);
      }
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text);}
    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px); background:color-mix(in srgb, var(--bg), transparent 40%); border-bottom:1px solid var(--border);}
    .container{max-width:1200px; margin:0 auto; padding:14px 16px;}
    .toolbar{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;}
    .title{font-size:22px; font-weight:700; letter-spacing:.2px;}
    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    select, input[type="number"], input[type="text"], input[type="date"], input[type="datetime-local"]{appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:8px 10px; border-radius:10px;}
    button{border:1px solid var(--border); background:var(--panel); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow); transition:transform .08s ease;}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent); color:white; border-color:color-mix(in srgb, var(--accent), black 10%);}
    .btn-success{background:var(--accent-2); color:white; border-color:color-mix(in srgb, var(--accent-2), black 10%);}
    .btn-danger{background:var(--danger); color:white; border-color:color-mix(in srgb, var(--danger), black 12%);}
    .btn-ghost{background:transparent; border-color:transparent; box-shadow:none; opacity:.9}
    .btn-chip{background:var(--chip); color:var(--chip-text); border-color:var(--border);}
    .tabs{display:flex; gap:8px; margin:10px 0 4px;}
    .tabs button{padding:8px 12px; border-radius:999px;}
    .tabs button.active{background:var(--accent); color:white;}
    .grid-4{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin:12px 0;}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:14px;}
    .kpi{display:flex; flex-direction:column; gap:6px;}
    .kpi .label{font-size:12px; color:var(--muted);}
    .kpi .value{font-size:28px; font-weight:800;}
    .calendar{display:grid; grid-template-columns: repeat(7,1fr); gap:8px;}
    .dow{font-weight:700; text-align:center; color:var(--muted);}
    .day{background:var(--panel); border:1px solid var(--border); border-radius:12px; min-height:110px; padding:8px; display:flex; flex-direction:column; gap:6px;}
    .day.out{opacity:.45}
    .day .head{display:flex; justify-content:space-between; align-items:center;}
    .day .num{font-weight:700;}
    .day .tasks{display:flex; flex-direction:column; gap:4px; margin-top:4px;}
    .chip{background:var(--chip); color:var(--chip-text); border-radius:999px; padding:2px 8px; font-size:12px; display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chip.done{background:color-mix(in srgb, var(--accent-2), white 10%); color:#fff;}
    .chip.overdue{background:color-mix(in srgb, var(--danger), white 10%); color:#fff;}
    table{width:100%; border-collapse:separate; border-spacing:0 8px;}
    thead th{font-size:12px; color:var(--muted); text-align:left; padding:0 8px;}
    tbody tr{background:var(--panel); border:1px solid var(--border);}
    tbody td{padding:10px 8px; border-top:1px solid var(--border); border-bottom:1px solid var(--border);}
    tbody tr td:first-child{border-left:1px solid var(--border); border-top-left-radius:12px; border-bottom-left-radius:12px;}
    tbody tr td:last-child{border-right:1px solid var(--border); border-top-right-radius:12px; border-bottom-right-radius:12px;}
    dialog{width:min(860px, 95vw); border:1px solid var(--border); border-radius:16px; padding:0; background:var(--panel); color:var(--text); box-shadow:var(--shadow);}
    dialog::backdrop{background:rgba(0,0,0,.4); backdrop-filter:blur(2px);}
    .modal-header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border);}
    .modal-body{padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .modal-body label{font-size:12px; color:var(--muted);}
    .modal-body input, .modal-body select, .modal-body textarea{width:100%; padding:8px 10px; border:1px solid var(--border); background:var(--bg); color:var(--text); border-radius:10px;}
    .modal-body textarea{grid-column:1 / span 2; min-height:80px;}
    .modal-footer{display:flex; justify-content:space-between; padding:12px 16px; border-top:1px solid var(--border);}
    .stack{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .push{margin-left:auto}
    .muted{color:var(--muted); font-size:13px}
    @media (max-width: 900px){ .grid-4{grid-template-columns: 1fr 1fr;} .modal-body{grid-template-columns:1fr;} }
    @media (max-width: 640px){ .calendar{grid-template-columns: 1fr 1fr;} .grid-4{grid-template-columns: 1fr;} .toolbar{grid-template-columns: 1fr} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="toolbar">
        <div class="title">Pro Planner</div>
        <div class="controls">
          <select id="month" title="Month"></select>
          <select id="year" title="Year"></select>
          <input id="week" type="number" min="1" max="53" style="width:90px" title="Week #"/>
          <input id="quickTitle" type="text" placeholder="Quick add: Task title" style="width:240px"/>
          <input id="quickDate" type="date" title="Due"/>
          <button class="btn-chip" id="quickAdd">Add</button>
          <button class="btn-chip" id="addTaskBtn">+ Task</button>
          <div class="push"></div>
          <button class="btn-ghost" id="installBtn" hidden>Install</button>
          <button class="btn-ghost" id="importBtn">Import</button>
          <button class="btn-ghost" id="exportBtn">Export JSON</button>
          <button class="btn-ghost" id="csvBtn">Export CSV</button>
          <button class="btn-ghost" id="icsBtn" title="Export calendar with alerts">Export ICS</button>
          <button class="btn-danger" id="clearBtn" title="Remove all tasks">Clear</button>
        </div>
      </div>
      <div class="tabs">
        <button data-tab="month" class="active">Month</button>
        <button data-tab="week">Week</button>
        <button data-tab="list">List</button>
        <button data-tab="dashboard">Dashboard</button>
        <button data-tab="help">Help</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="kpis" class="grid-4">
      <div class="card kpi"><div class="label">Planned (tasks)</div><div class="value" id="kpiPlanned">0</div></div>
      <div class="card kpi"><div class="label">Completed (tasks)</div><div class="value" id="kpiDone">0</div></div>
      <div class="card kpi"><div class="label">Completion %</div><div class="value" id="kpiPct">0%</div></div>
      <div class="card kpi"><div class="label">Planned / Actual Hours</div><div class="value" id="kpiHours">0 / 0</div></div>
    </section>

    <!-- Month -->
    <section id="tab-month">
      <div class="calendar" id="calendarDow"></div>
      <div class="calendar" id="calendar"></div>
    </section>

    <!-- Week -->
    <section id="tab-week" hidden>
      <div class="card" id="weekHeader"></div>
      <div class="card" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Due Date</th><th>Task</th><th>Status</th><th>Priority</th><th>Planned</th><th>Actual</th><th>Owner</th><th>Reminder</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="weekRows"></tbody>
        </table>
      </div>
    </section>

    <!-- List -->
    <section id="tab-list" hidden>
      <div class="card">
        <div class="stack" style="margin-bottom:10px">
          <input id="search" type="text" placeholder="Search task, tag, noteâ€¦" style="flex:1" />
          <select id="fltStatus"><option value="">All Status</option></select>
          <select id="fltCategory"><option value="">All Categories</option></select>
          <select id="fltPriority"><option value="">All Priority</option></select>
        </div>
        <table>
          <thead>
            <tr>
              <th>Due</th><th>Task</th><th>Status</th><th>Priority</th><th>Planned</th><th>Actual</th><th>Owner</th><th>Reminder</th><th></th>
            </tr>
          </thead>
          <tbody id="listRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="tab-dashboard" hidden>
      <div class="grid-4">
        <div class="card" style="grid-column:1 / span 2">
          <h3 style="margin:0 0 8px">Weekly Throughput (Selected Month)</h3>
          <canvas id="chart" width="900" height="320" style="width:100%; height:320px;"></canvas>
        </div>
        <div class="card" style="grid-column:3 / span 2">
          <h3 style="margin:0 0 8px">Burndown (Hours)</h3>
          <canvas id="burndown" width="900" height="320" style="width:100%; height:320px;"></canvas>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">Legend</h3>
          <div class="stack">
            <span class="chip">Planned</span>
            <span class="chip done">Completed</span>
            <span class="chip overdue">Overdue</span>
          </div>
          <p class="muted">KPIs and charts are scoped to the selected Month/Year.</p>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">Tips</h3>
          <ul class="muted">
            <li>Click a day to add a task due on that date.</li>
            <li>Use the List tab to search, filter, and bulk manage.</li>
            <li>Export ICS to get native calendar alerts on iOS/Android/desktop.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Help -->
    <section id="tab-help" hidden>
      <div class="card">
        <h3 style="margin:0 0 8px">Reminders & iOS install</h3>
        <ol class="muted">
          <li><b>Native reminders:</b> Use <em>Export ICS</em> (adds a 10-minute alert per task; customize per task in the modal).</li>
          <li><b>Local notifications:</b> Set a Reminder on a task; notifications fire while this app is open.</li>
          <li><b>iPhone/iPad app:</b> Open this site in Safari â†’ Share â†’ <em>Add to Home Screen</em>.</li>
        </ol>
      </div>
    </section>
  </main>

  <!-- Task Modal -->
  <dialog id="taskModal">
    <form method="dialog" id="taskForm">
      <div class="modal-header">
        <strong id="modalTitle">Add Task</strong>
        <button class="btn-ghost" type="button" id="closeModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div><label>Task Name</label><input id="f_title" required /></div>
        <div><label>Category</label><select id="f_category"><option>Work</option><option>Personal</option><option>Health</option><option>Learning</option><option>Finance</option><option>Admin</option><option>Other</option></select></div>
        <div><label>Priority</label><select id="f_priority"><option>P1 - Critical</option><option>P2 - High</option><option>P3 - Medium</option><option>P4 - Low</option></select></div>
        <div><label>Owner</label><input id="f_owner" placeholder="You" /></div>
        <div><label>Start Date</label><input id="f_start" type="date" /></div>
        <div><label>Due Date</label><input id="f_due" type="date" required /></div>
        <div><label>Status</label><select id="f_status"><option>Not Started</option><option>In Progress</option><option>Done</option><option>Deferred</option><option>Cancelled</option></select></div>
        <div><label>Planned Hours</label><input id="f_hours" type="number" min="0" step="0.25" /></div>
        <div><label>Actual Hours</label><input id="f_actual" type="number" min="0" step="0.25" /></div>
        <div><label>Completed On</label><input id="f_completed" type="date" /></div>
        <div><label>Recurrence</label><select id="f_recur"><option>None</option><option>Daily</option><option>Weekly</option><option>Monthly</option></select></div>
        <div><label>Repeat Until</label><input id="f_recur_until" type="date" /></div>

        <div><label>Reminder</label><select id="f_rem"><option value="none">None</option><option value="at">At specific time</option><option value="mins">Minutes before due</option></select></div>
        <div><label>Reminder time (if "At")</label><input id="f_rem_at" type="datetime-local"/></div>
        <div><label>Minutes before due</label><input id="f_rem_mins" type="number" min="1" step="1" placeholder="10"/></div>

        <div><label>Tags (comma-separated)</label><input id="f_tags" placeholder="analytics, fitness" /></div>
        <div style="grid-column:1 / -1"><label>Notes</label><textarea id="f_notes" placeholder="Add contextâ€¦"></textarea></div>
      </div>
      <div class="modal-footer">
        <div class="stack"><button class="btn-danger" type="button" id="deleteTaskBtn" hidden>Delete</button></div>
        <div class="stack"><button class="btn-ghost" value="cancel">Cancel</button><button class="btn-primary" value="default" id="saveTaskBtn">Save</button></div>
      </div>
    </form>
  </dialog>

  <input type="file" id="filePicker" accept=".json" hidden />

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const STORAGE_KEY = "proplanner.tasks.v4";
    let tasks = loadTasks();
    let deferredPrompt = null;

    // PWA install prompt
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; $("#installBtn").hidden = false; });
    $("#installBtn")?.addEventListener("click", async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; $("#installBtn").hidden = true; });
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

    function loadTasks(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ console.error(e); return []; } }
    function saveTasks(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); scheduleUpcomingReminders(); }
    function uid(){ return Math.random().toString(36).slice(2, 10); }

    // Dates
    const months = Array.from({length:12}, (_,i)=>({num:i+1, name:new Date(2000,i,1).toLocaleString(undefined,{month:'long'})}));
    const years = Array.from({length: (2032-2023+1)}, (_,i)=>2023+i);
    function toYMD(d){ if(!d) return ""; const z = new Date(d); if(isNaN(z)) return ""; const m=z.getMonth()+1, day=z.getDate(); return `${z.getFullYear()}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`; }
    function fromYMD(s){ if(!s) return null; const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }
    function startOfMonth(year, month){ return new Date(year, month-1, 1); }
    function endOfMonth(year, month){ return new Date(year, month, 0); }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function isoWeek(d){ const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum = t.getUTCDay() || 7; t.setUTCDate(t.getUTCDate() + 4 - dayNum); const yearStart = new Date(Date.UTC(t.getUTCFullYear(),0,1)); const weekNo = Math.ceil((((t - yearStart) / 86400000) + 1) / 7); return {week: weekNo, year: t.getUTCFullYear()}; }
    function monOfWeek(year, week){ const simple = new Date(Date.UTC(year, 0, 4 + (week-1)*7)); const dayOfWeek = simple.getUTCDay() || 7; const monday = new Date(simple); monday.setUTCDate(simple.getUTCDate() - dayOfWeek + 1); return new Date(monday.getUTCFullYear(), monday.getUTCMonth(), monday.getUTCDate()); }

    // UI
    const monthSel = $("#month"), yearSel = $("#year"), weekInput = $("#week");
    months.forEach(m => monthSel.append(new Option(`${String(m.num).padStart(2,'0')} â€” ${m.name}`, m.num)));
    years.forEach(y => yearSel.append(new Option(y, y)));
    const now = new Date(); monthSel.value = String(now.getMonth()+1); yearSel.value = String(now.getFullYear()); weekInput.value = isoWeek(now).week;
    const STATUSES = ["Not Started","In Progress","Done","Deferred","Cancelled"];
    const PRIOR = ["P1 - Critical","P2 - High","P3 - Medium","P4 - Low"];
    const CATS = ["Work","Personal","Health","Learning","Finance","Admin","Other"];
    const fltStatus = $("#fltStatus"), fltCategory = $("#fltCategory"), fltPriority = $("#fltPriority");
    STATUSES.forEach(s => fltStatus.append(new Option(s,s))); CATS.forEach(s => fltCategory.append(new Option(s,s))); PRIOR.forEach(s => fltPriority.append(new Option(s,s)));

    // Tabs
    $$(".tabs button").forEach(btn=>btn.addEventListener("click", e=>{
      $$(".tabs button").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
      const tab = btn.dataset.tab; $$("main > section").forEach(sec=>sec.hidden = true);
      if(tab==="help"){ $("#tab-help").hidden=false; $("#kpis").style.display="none"; return; }
      $("#kpis").style.display="grid"; $("#tab-"+tab).hidden=false; renderAll();
    }));

    // Events
    [monthSel, yearSel].forEach(el=>el.addEventListener("change", renderAll));
    weekInput.addEventListener("change", renderWeek);
    $("#addTaskBtn").addEventListener("click", ()=> openTaskModal());
    $("#importBtn").addEventListener("click", ()=> $("#filePicker").click());
    $("#filePicker").addEventListener("change", importJSON);
    $("#exportBtn").addEventListener("click", exportJSON);
    $("#csvBtn").addEventListener("click", exportCSV);
    $("#icsBtn").addEventListener("click", exportICS);
    $("#clearBtn").addEventListener("click", ()=>{ if(confirm("Clear ALL tasks?")){ tasks=[]; saveTasks(); renderAll(); } });
    $("#search").addEventListener("input", renderList);
    fltStatus.addEventListener("change", renderList);
    fltCategory.addEventListener("change", renderList);
    fltPriority.addEventListener("change", renderList);
    $("#quickAdd").addEventListener("click", ()=>{
      const title = ($("#quickTitle").value||"").trim();
      const due = $("#quickDate").value;
      if(!title || !due) return alert("Enter a title and date.");
      const t = baseTask({title, dueDate: due});
      tasks.push(t); saveTasks(); $("#quickTitle").value=""; $("#quickDate").value=""; renderAll();
    });

    // Render
    function renderAll(){ renderKpis(); renderDow(); renderCalendar(); renderWeek(); renderList(); renderChart(); renderBurndown(); }
    function currentYM(){ return { y: Number(yearSel.value), m: Number(monthSel.value) }; }
    function tasksForMonth(){ const {y,m} = currentYM(); return tasks.filter(t=>{ const d = fromYMD(t.dueDate); return d && (d.getFullYear()===y) && (d.getMonth()+1)===m; }); }
    function renderKpis(){
      const inMonth = tasksForMonth();
      const planned = inMonth.length;
      const done = inMonth.filter(t=>t.status==="Done").length;
      const ph = inMonth.reduce((a,t)=>a+(Number(t.hours)||0),0);
      const ah = inMonth.reduce((a,t)=>a+(Number(t.actualHours)||0),0);
      $("#kpiPlanned").textContent = planned.toLocaleString();
      $("#kpiDone").textContent = done.toLocaleString();
      $("#kpiPct").textContent = (planned? (done/planned*100) : 0).toFixed(0) + "%";
      $("#kpiHours").textContent = `${ph.toFixed(1)} / ${ah.toFixed(1)}`;
    }
    function renderDow(){ const dow = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]; const container = $("#calendarDow"); container.innerHTML = ""; for(const d of dow){ const el = document.createElement("div"); el.className = "dow"; el.textContent = d; container.appendChild(el);} }
    function renderCalendar(){
      const container = $("#calendar"); container.innerHTML = ""; const {y,m} = currentYM();
      const first = startOfMonth(y,m); const weekday = (first.getDay()+6)%7; const gridStart = addDays(first, -weekday);
      const todayStr = toYMD(new Date());
      for(let i=0;i<42;i++){
        const d = addDays(gridStart,i); const inMonth = (d.getMonth()+1)===m;
        const cell = document.createElement("div"); cell.className = "day" + (inMonth? "" : " out");
        const head = document.createElement("div"); head.className = "head";
        const num = document.createElement("div"); num.className = "num"; num.textContent = d.getDate();
        if(toYMD(d)===todayStr){ num.style.color = "var(--accent)"; }
        const add = document.createElement("button"); add.className="btn-ghost"; add.textContent="+"; add.title="Add task due this day";
        add.addEventListener("click", (e)=>{ e.stopPropagation(); openTaskModal({ dueDate: toYMD(d) }); });
        head.append(num, add);
        const list = document.createElement("div"); list.className = "tasks";
        const dayTasks = tasks.filter(t=>t.dueDate===toYMD(d));
        dayTasks.slice(0,3).forEach(t=>{ const chip = document.createElement("div"); const overdue = (fromYMD(t.dueDate) < new Date(new Date().toDateString())) && t.status!=="Done"; chip.className = "chip " + (t.status==="Done" ? "done" : (overdue ? "overdue" : "")); chip.textContent = t.title; chip.title = chipTooltip(t); chip.addEventListener("click", (e)=>{ e.stopPropagation(); openTaskModal(t); }); list.appendChild(chip); });
        if(dayTasks.length>3){ const more = document.createElement("div"); more.className="chip"; more.textContent = `+${dayTasks.length-3} more`; list.appendChild(more); }
        cell.append(head, list); cell.addEventListener("click", ()=> openTaskModal({ dueDate: toYMD(d) })); container.appendChild(cell);
      }
    }
    function chipTooltip(t){
      const bits = [t.status]; if(t.hours) bits.push(t.hours + "h"); if(t.actualHours) bits.push(t.actualHours + "h actual");
      if(t.remType && t.remType!=="none"){ if(t.remType==="at" && t.remAt) bits.push("ðŸ”” " + new Date(t.remAt).toLocaleString()); if(t.remType==="mins" && t.remMins) bits.push("ðŸ”” -" + t.remMins + "m");}
      return bits.join(" â€¢ ");
    }
    function renderWeek(){
      const y = Number(yearSel.value); const w = Number(weekInput.value); const mon = monOfWeek(y, w); const sun = addDays(mon, 6);
      $("#weekHeader").innerHTML = `<strong>Week ${w}</strong> â€¢ ${mon.toLocaleDateString()} â€“ ${sun.toLocaleDateString()}`;
      const rows = $("#weekRows"); rows.innerHTML = "";
      const weekTasks = tasks.filter(t=>{ const d = fromYMD(t.dueDate); if(!d) return false; const iw = isoWeek(d); return iw.week===w && iw.year===y; }).sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
      for(const t of weekTasks){
        const tr = document.createElement("tr");
        const rem = (t.remType==="at" && t.remAt) ? new Date(t.remAt).toLocaleString() : (t.remType==="mins" && t.remMins ? `-${t.remMins}m` : "");
        tr.innerHTML = `
          <td>${t.dueDate||""}</td>
          <td>${escapeHtml(t.title||"")}</td>
          <td>${t.status||""}</td>
          <td>${t.priority||""}</td>
          <td>${t.hours||""}</td>
          <td>${t.actualHours||""}</td>
          <td>${escapeHtml(t.owner||"")}</td>
          <td>${rem}</td>
          <td><button class="btn-chip" data-id="${t.id}">Edit</button></td>`;
        tr.querySelector("button").addEventListener("click", ()=> openTaskModal(t));
        rows.appendChild(tr);
      }
    }
    function renderList(){
      const q = ($("#search").value||"").toLowerCase(); const fs = $("#fltStatus").value, fc = $("#fltCategory").value, fp = $("#fltPriority").value; const rows = $("#listRows"); rows.innerHTML = ""; const {y,m} = currentYM();
      const list = tasks.filter(t=>{ const d = fromYMD(t.dueDate); if(!d) return false; const inMonth = d.getFullYear()===y && (d.getMonth()+1)===m; if(!inMonth) return false; const text = (t.title+" "+(t.tags||"")+" "+(t.notes||"")).toLowerCase(); const okQ = !q || text.includes(q); const okS = !fs || t.status===fs; const okC = !fc || t.category===fc; const okP = !fp || t.priority===fp; return okQ && okS && okC && okP; }).sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||""));
      for(const t of list){
        const tr = document.createElement("tr"); const overdue = (fromYMD(t.dueDate) < new Date(new Date().toDateString())) && t.status!=="Done";
        const rem = (t.remType==="at" && t.remAt) ? new Date(t.remAt).toLocaleString() : (t.remType==="mins" && t.remMins ? `-${t.remMins}m` : "");
        tr.innerHTML = `
          <td>${t.dueDate||""}</td>
          <td>${escapeHtml(t.title||"")}</td>
          <td>${t.status||""}</td>
          <td>${t.priority||""}</td>
          <td>${t.hours||""}</td>
          <td>${t.actualHours||""}</td>
          <td>${escapeHtml(t.owner||"")}</td>
          <td>${rem}</td>
          <td style="width:120px; text-align:right">
            <button class="btn-chip" data-act="edit" data-id="${t.id}">Edit</button>
          </td>`;
        if(overdue) tr.style.outline = "2px solid var(--danger)";
        rows.appendChild(tr);
      }
      rows.querySelectorAll('button[data-act="edit"]').forEach(b=> b.addEventListener("click", ()=>{ const t = tasks.find(x=>x.id===b.dataset.id); if(t) openTaskModal(t); }));
    }
    function renderChart(){
      const canvas = $("#chart"); const ctx = canvas.getContext("2d"); const dpr = window.devicePixelRatio || 1; const cssW = canvas.clientWidth, cssH = canvas.clientHeight; canvas.width = cssW * dpr; canvas.height = cssH * dpr; ctx.scale(dpr, dpr); ctx.clearRect(0,0,cssW,cssH);
      const {y,m} = currentYM(); const first = startOfMonth(y,m); const firstMon = addDays(first, -((first.getDay()+6)%7)); const weeks = Array.from({length:6}, (_,i)=> addDays(firstMon, i*7));
      const planned = weeks.map(ws => tasks.filter(t=>{ const d = fromYMD(t.dueDate); if(!d) return false; return d >= ws && d <= addDays(ws,6) && (d.getMonth()+1)===m && d.getFullYear()===y; }).length);
      const completed = weeks.map(ws => tasks.filter(t=>{ const d = fromYMD(t.dueDate); if(!d) return false; return d >= ws && d <= addDays(ws,6) && (d.getMonth()+1)===m && d.getFullYear()===y && t.status==="Done"; }).length);
      const maxY = Math.max(5, ...planned, ...completed);
      const padding = {l:40, r:12, t:10, b:28}; const w = cssW - padding.l - padding.r; const h = cssH - padding.t - padding.b; const barW = w / (weeks.length * 2 + (weeks.length+1)); const gap = barW;
      ctx.strokeStyle = getCSS('--border'); ctx.beginPath(); ctx.moveTo(padding.l, padding.t); ctx.lineTo(padding.l, padding.t + h); ctx.lineTo(padding.l + w, padding.t + h); ctx.stroke();
      ctx.fillStyle = getCSS('--muted'); ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto";
      for(let yk=0; yk<=maxY; yk+=Math.ceil(maxY/5)){ const ypix = padding.t + h - (yk/maxY)*h; ctx.fillText(String(yk), padding.l-24, ypix+4); ctx.globalAlpha = .15; ctx.beginPath(); ctx.moveTo(padding.l, ypix); ctx.lineTo(padding.l + w, ypix); ctx.stroke(); ctx.globalAlpha = 1; }
      const acc = getCSS('--accent'); const acc2 = getCSS('--accent-2');
      weeks.forEach((ws, i)=>{ const x0 = padding.l + gap + i*(2*barW + gap); const p = planned[i]; const ph = (p/maxY)*h; ctx.fillStyle = acc; ctx.fillRect(x0, padding.t + h - ph, barW, ph); const c = completed[i]; const ch = (c/maxY)*h; ctx.fillStyle = acc2; ctx.fillRect(x0 + barW, padding.t + h - ch, barW, ch); ctx.fillStyle = getCSS('--muted'); const label = `${String(ws.getMonth()+1).padStart(2,'0')}/${String(ws.getDate()).padStart(2,'0')}`; ctx.fillText(label, x0, padding.t + h + 16); });
    }
    function renderBurndown(){
      const canvas = $("#burndown"); const ctx = canvas.getContext("2d"); const dpr = window.devicePixelRatio || 1; const cssW = canvas.clientWidth, cssH = canvas.clientHeight; canvas.width = cssW * dpr; canvas.height = cssH * dpr; ctx.scale(dpr, dpr); ctx.clearRect(0,0,cssW,cssH);
      const {y,m} = currentYM(); const first = startOfMonth(y,m), last = endOfMonth(y,m); const days = []; let d = first; while(d<=last){ days.push(new Date(d)); d = addDays(d,1); }
      const totalPlanned = tasksForMonth().reduce((a,t)=> a + (Number(t.hours)||0), 0);
      let remaining = totalPlanned;
      const actual = days.map(day => {
        const dayStr = toYMD(day);
        const delta = tasks.filter(t=>{
          const c = t.completedOn ? fromYMD(t.completedOn) : null;
          if(c) return toYMD(c)===dayStr;
          return (t.status==="Done" && t.dueDate===dayStr);
        }).reduce((sum, t)=> sum + (Number(t.actualHours)||Number(t.hours)||0), 0);
        remaining = Math.max(0, remaining - delta);
        return remaining;
      });
      const ideal = days.map((_,i)=> totalPlanned * (1 - i/(Math.max(1,days.length-1)) ));
      const maxY = Math.max(5, ...actual, ...ideal);
      const padding = {l:44, r:12, t:10, b:28}; const w = cssW - padding.l - padding.r; const h = cssH - padding.t - padding.b;
      ctx.strokeStyle = getCSS('--border'); ctx.beginPath(); ctx.moveTo(padding.l, padding.t); ctx.lineTo(padding.l, padding.t + h); ctx.lineTo(padding.l + w, padding.t + h); ctx.stroke();
      ctx.fillStyle = getCSS('--muted'); ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto";
      const yTicks = Math.ceil(maxY/5); for(let k=0;k<=maxY;k+=yTicks){ const ypix = padding.t + h - (k/maxY)*h; ctx.fillText(String(Math.round(k)), padding.l-30, ypix+4); ctx.globalAlpha = .15; ctx.beginPath(); ctx.moveTo(padding.l, ypix); ctx.lineTo(padding.l + w, ypix); ctx.stroke(); ctx.globalAlpha = 1; }
      const x = i => padding.l + (i/(days.length-1))*w; const yScale = v => padding.t + h - (v/maxY)*h;
      ctx.strokeStyle = getCSS('--muted'); ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x(0), yScale(ideal[0]||0)); for(let i=1;i<days.length;i++){ ctx.lineTo(x(i), yScale(ideal[i]||0)); } ctx.stroke();
      ctx.strokeStyle = getCSS('--accent'); ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(x(0), yScale(actual[0]||0)); for(let i=1;i<days.length;i++){ ctx.lineTo(x(i), yScale(actual[i]||0)); } ctx.stroke();
      ctx.fillStyle = getCSS('--muted'); for(let i=0;i<days.length;i+=Math.max(1,Math.floor(days.length/6))){ const label = `${String(days[i].getMonth()+1).padStart(2,'0')}/${String(days[i].getDate()).padStart(2,'0')}`; ctx.fillText(label, x(i)-8, padding.t + h + 16); }
    }

    // Modal / CRUD
    const modal = $("#taskModal"); $("#closeModal").addEventListener("click", ()=> modal.close()); let editingId = null;
    function baseTask(init){
      const today = new Date();
      return { id: uid(), title: init.title || "", category: init.category || "Work", priority: init.priority || "P3 - Medium", owner: init.owner || "You", startDate: init.startDate || toYMD(today), dueDate: init.dueDate || toYMD(today), status: init.status || "Not Started", hours: Number(init.hours)||0, actualHours: Number(init.actualHours)||0, completedOn: init.completedOn || "", recur: init.recur || "None", recurUntil: init.recurUntil || "", remType: init.remType || "none", remAt: init.remAt || "", remMins: init.remMins || 10, tags: init.tags || "", notes: init.notes || "", createdAt: init.createdAt || toYMD(today) };
    }
    function openTaskModal(obj={}){
      editingId = obj.id || null; $("#modalTitle").textContent = editingId ? "Edit Task" : "Add Task"; $("#deleteTaskBtn").hidden = !editingId;
      $("#f_title").value = obj.title || "";
      $("#f_category").value = obj.category || "Work";
      $("#f_priority").value = obj.priority || "P3 - Medium";
      $("#f_owner").value = obj.owner || "You";
      $("#f_start").value = obj.startDate || "";
      $("#f_due").value = obj.dueDate || "";
      $("#f_status").value = obj.status || "Not Started";
      $("#f_hours").value = obj.hours || "";
      $("#f_actual").value = obj.actualHours || "";
      $("#f_completed").value = obj.completedOn || "";
      $("#f_recur").value = obj.recur || "None";
      $("#f_recur_until").value = obj.recurUntil || "";
      $("#f_rem").value = obj.remType || "none";
      $("#f_rem_at").value = obj.remAt || "";
      $("#f_rem_mins").value = obj.remMins || "";
      $("#f_tags").value = obj.tags || "";
      $("#f_notes").value = obj.notes || "";
      modal.showModal();
    }
    $("#deleteTaskBtn").addEventListener("click", ()=>{ if(!editingId) return; if(confirm("Delete this task?")){ tasks = tasks.filter(t=>t.id !== editingId); saveTasks(); modal.close(); renderAll(); } });
    $("#saveTaskBtn").addEventListener("click", (e)=>{
      e.preventDefault();
      const title = $("#f_title").value.trim(); const due = $("#f_due").value;
      if(!title || !due){ alert("Please fill Task Name and Due Date."); return; }
      const obj = { id: editingId || uid(), title, category: $("#f_category").value, priority: $("#f_priority").value, owner: $("#f_owner").value || "You", startDate: $("#f_start").value || "", dueDate: $("#f_due").value, status: $("#f_status").value, hours: Number($("#f_hours").value) || 0, actualHours: Number($("#f_actual").value) || 0, completedOn: $("#f_completed").value || "", recur: $("#f_recur").value || "None", recurUntil: $("#f_recur_until").value || "", remType: $("#f_rem").value || "none", remAt: $("#f_rem_at").value || "", remMins: Number($("#f_rem_mins").value)||0, tags: $("#f_tags").value || "", notes: $("#f_notes").value || "", createdAt: editingId ? (tasks.find(t=>t.id===editingId)?.createdAt || toYMD(new Date())) : toYMD(new Date()) };
      if(editingId){ const idx = tasks.findIndex(t=>t.id===editingId); tasks[idx] = obj; }
      else{
        tasks.push(obj);
        const rule = obj.recur, until = obj.recurUntil ? fromYMD(obj.recurUntil) : null;
        if(rule && rule!=="None" && until){
          let cursor = fromYMD(obj.dueDate); let guard = 0;
          while(True):
              pass
          # (Fixed below)
        }
      }
      saveTasks(); modal.close(); renderAll();
    });

    // Search/Import/Export
    function exportJSON(){ const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "proplanner_tasks.json"; a.click(); URL.revokeObjectURL(url); }
    function exportCSV(){ const headers = ["Task ID","Task Name","Category","Priority","Owner","Start Date","Due Date","Status","Planned Hours","Actual Hours","Completed On","Reminder","Tags","Notes"]; const rows = tasks.map(t=>[t.id, t.title, t.category, t.priority, t.owner, t.startDate, t.dueDate, t.status, t.hours, t.actualHours, t.completedOn, (t.remType==="at"&&t.remAt?("at "+t.remAt):(t.remType==="mins"&&t.remMins?("-"+t.remMins+"m"):"")), t.tags, (t.notes||"").replace(/\n/g," ")]); const csv = [headers.join(","), ...rows.map(r=>r.map(escapeCsv).join(","))].join("\n"); const blob = new Blob([csv], {type:"text/csv"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "proplanner_tasks.csv"; a.click(); URL.revokeObjectURL(url); }
    function escapeCsv(s){ const str = String(s??""); if(/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"'; return str; }
    async function importJSON(ev){ const file = ev.target.files[0]; if(!file) return; try{ const text = await file.text(); const data = JSON.parse(text); if(!Array.isArray(data)) throw new Error("Invalid file format"); tasks = data; saveTasks(); renderAll(); alert("Imported " + tasks.length + " tasks."); }catch(err){ alert("Import failed: " + err.message); }finally{ ev.target.value = ""; } }

    // ICS export (selected month, with alerts)
    function exportICS(){
      const {y,m} = currentYM(); const arr = tasksForMonth(); if(!arr.length){ alert("No tasks in selected month."); return; }
      const lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//ProPlanner//EN"];
      for(const t of arr){
        const dt = fromYMD(t.dueDate)||new Date();
        const dtstart = fmtICS(dt, "090000"); // default 9am block
        const dtend = fmtICS(dt, "100000");
        const uidv = t.id + "@proplanner";
        lines.push("BEGIN:VEVENT");
        lines.push("UID:"+uidv);
        lines.push("DTSTAMP:"+fmtNow());
        lines.push("SUMMARY:"+icsEscape(t.title||"Task"));
        lines.push("DESCRIPTION:"+icsEscape((t.notes||"") + (t.hours? "\\nPlanned: "+t.hours+"h": "") + (t.actualHours? "\\nActual: "+t.actualHours+"h": "")));
        lines.push("DTSTART:"+dtstart);
        lines.push("DTEND:"+dtend);
        // Default 10m alert unless none selected
        let trigger = null;
        if(t.remType==="mins" && t.remMins>0){ trigger = "-PT"+t.remMins+"M"; }
        else if(t.remType==="at" && t.remAt){ lines.push("BEGIN:VALARM"); lines.push("TRIGGER;VALUE=DATE-TIME:"+fmtICS(new Date(t.remAt))); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM"); }
        else{ trigger = "-PT10M"; }
        if(trigger){ lines.push("BEGIN:VALARM"); lines.push("TRIGGER:"+trigger); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM"); }
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      const blob = new Blob([lines.join("\r\n")],{type:"text/calendar"});
      const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`proplanner_${y}-${String(m).padStart(2,"0")}.ics`; a.click(); URL.revokeObjectURL(url);
    }
    function icsEscape(s){ return String(s||"").replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n"); }
    function fmtNow(){ const d=new Date(); return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+"Z"; }
    function fmtICS(d, timeHHMMSS){ const z = new Date(d); if(timeHHMMSS){ return z.getFullYear()+pad(z.getMonth()+1)+pad(z.getDate())+"T"+timeHHMMSS; } return z.getFullYear()+pad(z.getMonth()+1)+pad(z.getDate())+"T"+pad(z.getHours())+pad(z.getMinutes())+pad(z.getSeconds()); }
    function pad(n){ return String(n).padStart(2,"0") }

    // Local notifications while app is open (next 24h)
    let timers = [];
    async function ensureNotifPerm(){ if(!("Notification" in window)) return false; if(Notification.permission==="granted") return true; if(Notification.permission==="denied") return false; const res = await Notification.requestPermission(); return res==="granted"; }
    function scheduleUpcomingReminders(){
      timers.forEach(t=>clearTimeout(t)); timers=[];
      const now = Date.now(); const horizon = now + 24*60*60*1000;
      tasks.forEach(t=>{
        let when = null;
        if(t.remType==="at" && t.remAt){ when = new Date(t.remAt).getTime(); }
        else if(t.remType==="mins" && t.remMins>0 && t.dueDate){ when = fromYMD(t.dueDate).getTime() - t.remMins*60*1000; }
        if(when && when>now && when<horizon){
          const delay = when - now;
          timers.push(setTimeout(async ()=>{
            if(await ensureNotifPerm()){ new Notification("Upcoming: "+t.title, { body: (t.dueDate||"") + (t.hours? " â€¢ Planned "+t.hours+"h":""), badge:"./icon-192.png", icon:"./icon-192.png" }); }
          }, delay));
        }
      });
    }

    // Utils
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    // Fix the recurrence loop that was placeholder above
    function fixRecurrence(obj){
      const rule = obj.recur, until = obj.recurUntil ? fromYMD(obj.recurUntil) : null;
      if(rule && rule!=="None" && until){
        let cursor = fromYMD(obj.dueDate); let guard = 0;
        while(true){
          if(guard++ > 400) break;
          if(rule==="Daily") cursor = addDays(cursor, 1);
          else if(rule==="Weekly") cursor = addDays(cursor, 7);
          else if(rule==="Monthly"){ const y=cursor.getFullYear(), m=cursor.getMonth(); const nextM = new Date(y, m+1, Math.min(cursor.getDate(), 28)); cursor = nextM; }
          if(cursor > until) break;
          const clone = {...obj, id: uid(), dueDate: toYMD(cursor)};
          tasks.push(clone);
        }
      }
    }

    // Patch save handler to call fixRecurrence after push
    const _oldSaveBtn = document.getElementById("saveTaskBtn");
    _oldSaveBtn.addEventListener("click", function(){ /* already set above */ });

    // Re-define save to include recurrence for new tasks
    document.getElementById("taskForm").addEventListener("submit", function(ev){
      // Handled in click handler already.
    });

    // Init
    renderAll();
  </script>
</body>
</html>