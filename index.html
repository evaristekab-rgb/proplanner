
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pro Planner â€” Pro Reminders</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0b10">
<style>
:root{
  --bg:#0b0b10; --panel:#141420; --muted:#a3a3b2; --text:#eaeaf2;
  --accent:#6ea8fe; --accent-2:#7bd389; --danger:#ff6b6b; --border:#2c2c3d;
  --chip:#232336; --chip-text:#d7d7e2; --shadow:0 10px 20px rgba(0,0,0,.35), 0 6px 6px rgba(0,0,0,.28);
}
*{box-sizing:border-box}
body{margin:0; font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text);}
header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px); background:rgba(11,11,16,.7); border-bottom:1px solid var(--border);}
.container{max-width:1200px; margin:0 auto; padding:14px 16px;}
.toolbar{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;}
.title{font-weight:800; letter-spacing:.2px;}
.controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
select,input[type="date"],input[type="number"],input[type="text"],input[type="datetime-local"]{border:1px solid var(--border); background:var(--panel); color:var(--text); padding:8px 10px; border-radius:10px;}
button{border:1px solid var(--border); background:var(--panel); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow);}
.btn-chip{background:var(--chip); color:var(--chip-text);}
.btn-danger{background:var(--danger); color:#fff; border-color:#b33;}
.tabs{display:flex; gap:8px; margin:10px 0 4px;}
.tabs button{padding:8px 12px; border-radius:999px;}
.tabs button.active{background:var(--accent); color:#fff;}
.grid-4{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:12px 0;}
.card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:14px;}
.kpi .label{font-size:12px; color:var(--muted);} .kpi .value{font-size:28px; font-weight:800;}

.calendar{display:grid; grid-template-columns:repeat(7,1fr); grid-auto-rows:minmax(140px,auto); gap:8px;}
.dow{font-weight:700; text-align:center; color:var(--muted); padding:6px 0; border-bottom:1px solid var(--border);}
.day{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:8px; display:flex; flex-direction:column; gap:6px; min-width:0; overflow:hidden;}
.day.out{opacity:.45}
.day .head{display:flex; justify-content:space-between; align-items:center; gap:8px;}
.day .num{font-weight:700;}
.day .tasks{display:flex; flex-direction:column; gap:6px; margin-top:4px; min-width:0;}
/* CHIP FIX: never overflow into next day; wrap long words; expand cell height instead. */
.chip{
  display:block;               /* allow line wrapping */
  background:var(--chip); color:var(--chip-text);
  border-radius:999px; padding:6px 10px; font-size:12px;
  border:1px solid var(--border);
  line-height:1.2;
  max-width:100%; min-width:0;
  overflow-wrap:anywhere;      /* break very long words */
  word-break:break-word;
  white-space:normal;
}
.chip.done{background:#1e874b; color:#fff;} .chip.overdue{background:#b23; color:#fff;}

table{width:100%; border-collapse:separate; border-spacing:0 8px;}
thead th{font-size:12px; color:var(--muted); text-align:left; padding:0 8px;}
tbody tr{background:var(--panel); border:1px solid var(--border);} tbody td{padding:10px 8px;}
tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px; border-left:1px solid var(--border);}
tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px; border-right:1px solid var(--border);}

dialog{width:min(860px,95vw); border:1px solid var(--border); border-radius:16px; padding:0; background:var(--panel); color:var(--text);}
dialog::backdrop{background:rgba(0,0,0,.4);}
.modal-header,.modal-footer{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border);}
.modal-footer{border-top:1px solid var(--border); border-bottom:none}
.modal-body{padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px;}
.modal-body textarea{grid-column:1/-1; min-height:80px;}
.stack{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
.push{margin-left:auto}
.muted{color:var(--muted); font-size:13px}
@media (max-width:900px){ .grid-4{grid-template-columns:1fr 1fr} .modal-body{grid-template-columns:1fr} }
@media (max-width:640px){ .calendar{grid-template-columns:1fr 1fr} .grid-4{grid-template-columns:1fr} .toolbar{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="toolbar">
      <div class="title">Pro Planner</div>
      <div class="controls">
        <select id="month"></select>
        <select id="year"></select>
        <input id="week" type="number" min="1" max="53" style="width:90px" title="Week #">
        <input id="quickTitle" type="text" placeholder="Quick add: Task title" style="width:240px">
        <input id="quickDate" type="date">
        <button class="btn-chip" id="quickAdd">Add</button>
        <button class="btn-chip" id="addTaskBtn">+ Task</button>
        <div class="push"></div>
        <button class="btn-chip" id="importBtn">Import</button>
        <button class="btn-chip" id="exportBtn">Export JSON</button>
        <button class="btn-chip" id="csvBtn">Export CSV</button>
        <button class="btn-chip" id="icsBtn">Export ICS</button>
        <button class="btn-danger" id="clearBtn">Clear</button>
      </div>
    </div>
    <div class="tabs">
      <button data-tab="month" class="active">Month</button>
      <button data-tab="week">Week</button>
      <button data-tab="list">List</button>
      <button data-tab="dashboard">Dashboard</button>
      <button data-tab="help">Help</button>
    </div>
  </div>
</header>

<main class="container">
  <section id="kpis" class="grid-4">
    <div class="card kpi"><div class="label">Planned (tasks)</div><div class="value" id="kpiPlanned">0</div></div>
    <div class="card kpi"><div class="label">Completed (tasks)</div><div class="value" id="kpiDone">0</div></div>
    <div class="card kpi"><div class="label">Completion %</div><div class="value" id="kpiPct">0%</div></div>
    <div class="card kpi"><div class="label">Planned / Actual Hours</div><div class="value" id="kpiHours">0 / 0</div></div>
  </section>

  <section id="tab-month">
    <div class="calendar" id="calendarDow"></div>
    <div class="calendar" id="calendar"></div>
  </section>

  <section id="tab-week" hidden>
    <div class="card" id="weekHeader"></div>
    <div class="card" style="margin-top:12px">
      <table>
        <thead><tr><th>Due</th><th>Task</th><th>Status</th><th>Priority</th><th>Planned</th><th>Actual</th><th>Owner</th><th>Reminder</th><th>Actions</th></tr></thead>
        <tbody id="weekRows"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-list" hidden>
    <div class="card">
      <div class="stack" style="margin-bottom:10px">
        <input id="search" type="text" placeholder="Search task, tag, noteâ€¦" style="flex:1">
        <select id="fltStatus"><option value="">All Status</option></select>
        <select id="fltCategory"><option value="">All Categories</option></select>
        <select id="fltPriority"><option value="">All Priority</option></select>
      </div>
      <table>
        <thead><tr><th>Due</th><th>Task</th><th>Status</th><th>Priority</th><th>Planned</th><th>Actual</th><th>Owner</th><th>Reminder</th><th></th></tr></thead>
        <tbody id="listRows"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-dashboard" hidden>
    <div class="grid-4">
      <div class="card" style="grid-column:1 / span 2">
        <h3 style="margin:0 0 8px">Weekly Throughput (Selected Month)</h3>
        <canvas id="chart" width="900" height="320" style="width:100%; height:320px;"></canvas>
      </div>
      <div class="card" style="grid-column:3 / span 2">
        <h3 style="margin:0 0 8px">Burndown (Hours)</h3>
        <canvas id="burndown" width="900" height="320" style="width:100%; height:320px;"></canvas>
      </div>
    </div>
  </section>

  <section id="tab-help" hidden>
    <div class="card">
      <h3 style="margin:0 0 8px">Reminders & iOS</h3>
      <ol class="muted">
        <li>Use <b>Export ICS</b> to add all tasks (with alerts) to your device calendar.</li>
        <li>Local notifications fire while the app is open for tasks scheduled in the next 24h.</li>
      </ol>
    </div>
  </section>
</main>

<dialog id="taskModal">
  <form method="dialog" id="taskForm">
    <div class="modal-header">
      <strong id="modalTitle">Add Task</strong>
      <button type="button" id="closeModal">âœ•</button>
    </div>
    <div class="modal-body">
      <div><label>Task Name</label><input id="f_title" required></div>
      <div><label>Category</label><select id="f_category"><option>Work</option><option>Personal</option><option>Health</option><option>Learning</option><option>Finance</option><option>Admin</option><option>Other</option></select></div>
      <div><label>Priority</label><select id="f_priority"><option>P1 - Critical</option><option>P2 - High</option><option>P3 - Medium</option><option>P4 - Low</option></select></div>
      <div><label>Owner</label><input id="f_owner" placeholder="You"></div>
      <div><label>Start Date</label><input id="f_start" type="date"></div>
      <div><label>Due Date</label><input id="f_due" type="date" required></div>
      <div><label>Status</label><select id="f_status"><option>Not Started</option><option>In Progress</option><option>Done</option><option>Deferred</option><option>Cancelled</option></select></div>
      <div><label>Planned Hours</label><input id="f_hours" type="number" min="0" step="0.25"></div>
      <div><label>Actual Hours</label><input id="f_actual" type="number" min="0" step="0.25"></div>
      <div><label>Completed On</label><input id="f_completed" type="date"></div>
      <div><label>Recurrence</label><select id="f_recur"><option>None</option><option>Daily</option><option>Weekly</option><option>Monthly</option></select></div>
      <div><label>Repeat Until</label><input id="f_recur_until" type="date"></div>
      <div><label>Reminder</label><select id="f_rem"><option value="none">None</option><option value="at">At specific time</option><option value="mins">Minutes before due</option></select></div>
      <div><label>Reminder time (if 'At')</label><input id="f_rem_at" type="datetime-local"></div>
      <div><label>Minutes before due</label><input id="f_rem_mins" type="number" min="1" step="1" placeholder="10"></div>
      <div><label>Tags</label><input id="f_tags" placeholder="analytics, fitness"></div>
      <div style="grid-column:1 / -1"><label>Notes</label><textarea id="f_notes" placeholder="Add contextâ€¦"></textarea></div>
    </div>
    <div class="modal-footer">
      <div class="stack"><button class="btn-danger" type="button" id="deleteTaskBtn" hidden>Delete</button></div>
      <div class="stack"><button value="cancel">Cancel</button><button id="saveTaskBtn" value="default">Save</button></div>
    </div>
  </form>
</dialog>

<input type="file" id="filePicker" accept=".json" hidden>

<script>
const $ = (s,el=document)=>el.querySelector(s), $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const STORAGE_KEY="proplanner.tasks.v4"; let tasks=loadTasks();

function loadTasks(){ try{const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[]}catch(e){return[]} }
function saveTasks(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); scheduleUpcomingReminders(); }
function uid(){ return Math.random().toString(36).slice(2,10); }

function toYMD(d){ if(!d) return ""; const z=new Date(d); return z.getFullYear()+"-"+String(z.getMonth()+1).padStart(2,'0')+"-"+String(z.getDate()).padStart(2,'0'); }
function fromYMD(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function startOfMonth(y,m){ return new Date(y,m-1,1); }
function endOfMonth(y,m){ return new Date(y,m,0); }
function isoWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=t.getUTCDay()||7; t.setUTCDate(t.getUTCDate()+4-day); const yStart=new Date(Date.UTC(t.getUTCFullYear(),0,1)); return {week:Math.ceil((((t-yStart)/86400000)+1)/7), year:t.getUTCFullYear()}; }
function monOfWeek(year,week){ const simple=new Date(Date.UTC(year,0,4+(week-1)*7)); const day=simple.getUTCDay()||7; const mon=new Date(simple); mon.setUTCDate(simple.getUTCDate()-day+1); return new Date(mon.getUTCFullYear(),mon.getUTCMonth(),mon.getUTCDate()); }

const monthSel=$("#month"), yearSel=$("#year"), weekInput=$("#week");
const months=Array.from({length:12},(_,i)=>({n:i+1,name:new Date(2000,i,1).toLocaleString(undefined,{month:'long'})}));
const years=Array.from({length:10},(_,i)=>new Date().getFullYear()-1+i);
months.forEach(m=>monthSel.append(new Option(String(m.n).padStart(2,'0')+" â€” "+m.name,m.n)));
years.forEach(y=>yearSel.append(new Option(y,y)));
const now=new Date(); monthSel.value=String(now.getMonth()+1); yearSel.value=String(now.getFullYear()); weekInput.value=isoWeek(now).week;

const STATUSES=["Not Started","In Progress","Done","Deferred","Cancelled"];
const PRIOR=["P1 - Critical","P2 - High","P3 - Medium","P4 - Low"];
const CATS=["Work","Personal","Health","Learning","Finance","Admin","Other"];
const fltStatus=$("#fltStatus"), fltCategory=$("#fltCategory"), fltPriority=$("#fltPriority");
STATUSES.forEach(s=>fltStatus.append(new Option(s,s))); CATS.forEach(s=>fltCategory.append(new Option(s,s))); PRIOR.forEach(s=>fltPriority.append(new Option(s,s)));

$$(".tabs button").forEach(btn=>btn.addEventListener("click",()=>{
  $$(".tabs button").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
  const tab=btn.dataset.tab; $$("main > section").forEach(sec=>sec.hidden=true);
  if(tab==="help"){ $("#tab-help").hidden=false; $("#kpis").style.display="none"; return; }
  $("#kpis").style.display="grid"; $("#tab-"+tab).hidden=false; renderAll();
}));

[monthSel,yearSel].forEach(el=>el.addEventListener("change", renderAll));
weekInput.addEventListener("change", renderWeek);
$("#addTaskBtn").addEventListener("click",()=>openTaskModal());
$("#importBtn").addEventListener("click",()=>$("#filePicker").click());
$("#filePicker").addEventListener("change", importJSON);
$("#exportBtn").addEventListener("click", exportJSON);
$("#csvBtn").addEventListener("click", exportCSV);
$("#icsBtn").addEventListener("click", exportICS);
$("#clearBtn").addEventListener("click",()=>{ if(confirm("Clear ALL tasks?")){ tasks=[]; saveTasks(); renderAll(); }});
$("#search").addEventListener("input", renderList);
fltStatus.addEventListener("change", renderList); fltCategory.addEventListener("change", renderList); fltPriority.addEventListener("change", renderList);
$("#quickAdd").addEventListener("click",()=>{ const title=($("#quickTitle").value||"").trim(); const due=$("#quickDate").value; if(!title||!due) return alert("Enter a title and date."); const t=baseTask({title, dueDate:due}); tasks.push(t); saveTasks(); $("#quickTitle").value=""; $("#quickDate").value=""; renderAll(); });

function baseTask(init){ const today=new Date(); return { id:uid(), title:init.title||"", category:init.category||"Work", priority:init.priority||"P3 - Medium", owner:init.owner||"You", startDate:init.startDate||toYMD(today), dueDate:init.dueDate||toYMD(today), status:init.status||"Not Started", hours:Number(init.hours)||0, actualHours:Number(init.actualHours)||0, completedOn:init.completedOn||"", recur:init.recur||"None", recurUntil:init.recurUntil||"", remType:init.remType||"none", remAt:init.remAt||"", remMins:init.remMins||10, tags:init.tags||"", notes:init.notes||"", createdAt:init.createdAt||toYMD(today) }; }

const modal=$("#taskModal"); let editingId=null; $("#closeModal").addEventListener("click",()=>modal.close());
function openTaskModal(obj={}){
  editingId=obj.id||null; $("#modalTitle").textContent=editingId?"Edit Task":"Add Task"; $("#deleteTaskBtn").hidden=!editingId;
  $("#f_title").value=obj.title||""; $("#f_category").value=obj.category||"Work"; $("#f_priority").value=obj.priority||"P3 - Medium"; $("#f_owner").value=obj.owner||"You";
  $("#f_start").value=obj.startDate||""; $("#f_due").value=obj.dueDate||""; $("#f_status").value=obj.status||"Not Started";
  $("#f_hours").value=obj.hours||""; $("#f_actual").value=obj.actualHours||""; $("#f_completed").value=obj.completedOn||"";
  $("#f_recur").value=obj.recur||"None"; $("#f_recur_until").value=obj.recurUntil||"";
  $("#f_rem").value=obj.remType||"none"; $("#f_rem_at").value=obj.remAt||""; $("#f_rem_mins").value=obj.remMins||"";
  $("#f_tags").value=obj.tags||""; $("#f_notes").value=obj.notes||"";
  modal.showModal();
}
$("#deleteTaskBtn").addEventListener("click",()=>{ if(!editingId) return; if(confirm("Delete this task?")){ tasks=tasks.filter(t=>t.id!==editingId); saveTasks(); modal.close(); renderAll(); }});
$("#saveTaskBtn").addEventListener("click",(e)=>{
  e.preventDefault();
  const title=$("#f_title").value.trim(), due=$("#f_due").value; if(!title||!due){ alert("Please fill Task Name and Due Date."); return; }
  const obj={ id:editingId||uid(), title, category:$("#f_category").value, priority:$("#f_priority").value, owner:=$("#f_owner").value||"You", startDate:=$("#f_start").value||"", dueDate:=$("#f_due").value, status:=$("#f_status").value, hours:Number($("#f_hours").value)||0, actualHours:Number($("#f_actual").value)||0, completedOn:=$("#f_completed").value||"", recur:=$("#f_recur").value||"None", recurUntil:=$("#f_recur_until").value||"", remType:=$("#f_rem").value||"none", remAt:=$("#f_rem_at").value||"", remMins:Number($("#f_rem_mins").value)||0, tags:=$("#f_tags").value||"", notes:=$("#f_notes").value||"", createdAt: editingId?(tasks.find(t=>t.id===editingId)?.createdAt||toYMD(new Date())):toYMD(new Date()) };
  if(editingId){ const idx=tasks.findIndex(t=>t.id===editingId); tasks[idx]=obj; }
  else{ tasks.push(obj); const rule=obj.recur, until=obj.recurUntil?fromYMD(obj.recurUntil):null; if(rule&&rule!=="None"&&until){ let cursor=fromYMD(obj.dueDate); let guard=0; while(true){ if(guard++>400) break; if(rule==="Daily") cursor=addDays(cursor,1); else if(rule==="Weekly") cursor=addDays(cursor,7); else if(rule==="Monthly"){ const y=cursor.getFullYear(), m=cursor.getMonth(); cursor=new Date(y,m+1,Math.min(cursor.getDate(),28)); } if(cursor>until) break; const clone={...obj, id:uid(), dueDate:toYMD(cursor)}; tasks.push(clone);} } }
  saveTasks(); modal.close(); renderAll();
});

function renderAll(){ renderKpis(); renderDow(); renderCalendar(); renderWeek(); renderList(); renderChart(); renderBurndown(); }
function currentYM(){ return {y:Number(yearSel.value), m:Number(monthSel.value)}; }
function tasksForMonth(){ const {y,m}=currentYM(); return tasks.filter(t=>{ const d=fromYMD(t.dueDate); return d && d.getFullYear()===y && (d.getMonth()+1)===m; }); }
function renderKpis(){ const inMonth=tasksForMonth(); const planned=inMonth.length; const done=inMonth.filter(t=>t.status==="Done").length; const ph=inMonth.reduce((a,t)=>a+(Number(t.hours)||0),0); const ah=inMonth.reduce((a,t)=>a+(Number(t.actualHours)||0),0); $("#kpiPlanned").textContent=planned; $("#kpiDone").textContent=done; $("#kpiPct").textContent=(planned?(done/planned*100):0).toFixed(0)+"%"; $("#kpiHours").textContent=`${ph.toFixed(1)} / ${ah.toFixed(1)}`; }
function renderDow(){ const dow=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]; const container=$("#calendarDow"); container.innerHTML=""; dow.forEach(d=>{const el=document.createElement("div"); el.className="dow"; el.textContent=d; container.appendChild(el);}); }
function chipTooltip(t){ const bits=[t.status]; if(t.hours) bits.push(t.hours+"h"); if(t.actualHours) bits.push(t.actualHours+"h actual"); if(t.remType==="at"&&t.remAt) bits.push("ðŸ”” "+new Date(t.remAt).toLocaleString()); if(t.remType==="mins"&&t.remMins) bits.push("ðŸ”” -"+t.remMins+"m"); return bits.join(" â€¢ "); }
function renderCalendar(){ const container=$("#calendar"); container.innerHTML=""; const {y,m}=currentYM(); const first=startOfMonth(y,m); const weekday=(first.getDay()+6)%7; const gridStart=addDays(first,-weekday); const todayStr=toYMD(new Date()); for(let i=0;i<42;i++){ const d=addDays(gridStart,i); const inMonth=(d.getMonth()+1)===m; const cell=document.createElement("div"); cell.className="day"+(inMonth?"":" out"); const head=document.createElement("div"); head.className="head"; const num=document.createElement("div"); num.className="num"; num.textContent=d.getDate(); if(toYMD(d)===todayStr) num.style.color="var(--accent)"; const addBtn=document.createElement("button"); addBtn.className="btn-chip"; addBtn.textContent="+"; addBtn.title="Add task"; addBtn.addEventListener("click",(e)=>{ e.stopPropagation(); openTaskModal({dueDate:toYMD(d)});}); head.append(num,addBtn); const list=document.createElement("div"); list.className="tasks"; tasks.filter(t=>t.dueDate===toYMD(d)).forEach(t=>{ const chip=document.createElement("div"); const overdue=(fromYMD(t.dueDate)<new Date(new Date().toDateString()))&&t.status!=="Done"; chip.className="chip "+(t.status==="Done"?"done":(overdue?"overdue":"")); chip.textContent=t.title; chip.title=chipTooltip(t); chip.addEventListener("click",(e)=>{ e.stopPropagation(); openTaskModal(t);}); list.appendChild(chip); }); cell.append(head,list); cell.addEventListener("click",()=>openTaskModal({dueDate:toYMD(d)})); container.appendChild(cell);} }
function renderWeek(){ const y=Number(yearSel.value); const w=Number(weekInput.value); const mon=monOfWeek(y,w); const sun=addDays(mon,6); $("#weekHeader").innerHTML=`<strong>Week ${w}</strong> â€¢ ${mon.toLocaleDateString()} â€“ ${sun.toLocaleDateString()}`; const rows=$("#weekRows"); rows.innerHTML=""; const weekTasks=tasks.filter(t=>{ const d=fromYMD(t.dueDate); if(!d) return false; const iw=isoWeek(d); return iw.week===w && iw.year===y; }).sort((a,b)=>(a.dueDate||"").localeCompare(b.dueDate||"")); for(const t of weekTasks){ const tr=document.createElement("tr"); const rem=(t.remType==="at"&&t.remAt)?new Date(t.remAt).toLocaleString():(t.remType==="mins"&&t.remMins?`-${t.remMins}m`:""); tr.innerHTML=`<td>${t.dueDate||""}</td><td>${escapeHtml(t.title||"")}</td><td>${t.status||""}</td><td>${t.priority||""}</td><td>${t.hours||""}</td><td>${t.actualHours||""}</td><td>${escapeHtml(t.owner||"")}</td><td>${rem}</td><td><button class="btn-chip" data-id="${t.id}">Edit</button></td>`; tr.querySelector("button").addEventListener("click",()=>openTaskModal(t)); rows.appendChild(tr);} }
function renderList(){ const q=($("#search").value||"").toLowerCase(); const fs=$("#fltStatus").value, fc=$("#fltCategory").value, fp=$("#fltPriority").value; const rows=$("#listRows"); rows.innerHTML=""; const {y,m}=currentYM(); const list=tasks.filter(t=>{ const d=fromYMD(t.dueDate); if(!d) return false; const inMonth=d.getFullYear()===y && (d.getMonth()+1)===m; if(!inMonth) return false; const text=(t.title+" "+(t.tags||"")+" "+(t.notes||"")).toLowerCase(); const okQ=!q||text.includes(q); const okS=!fs||t.status===fs; const okC=!fc||t.category===fc; const okP=!fp||t.priority===fp; return okQ&&okS&&okC&&okP; }).sort((a,b)=>(a.dueDate||"").localeCompare(b.dueDate||"")); for(const t of list){ const tr=document.createElement("tr"); const rem=(t.remType==="at"&&t.remAt)?new Date(t.remAt).toLocaleString():(t.remType==="mins"&&t.remMins?`-${t.remMins}m`:""); tr.innerHTML=`<td>${t.dueDate||""}</td><td>${escapeHtml(t.title||"")}</td><td>${t.status||""}</td><td>${t.priority||""}</td><td>${t.hours||""}</td><td>${t.actualHours||""}</td><td>${escapeHtml(t.owner||"")}</td><td>${rem}</td><td style="text-align:right"><button class="btn-chip" data-act="edit" data-id="${t.id}">Edit</button></td>`; rows.appendChild(tr);} rows.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener("click",()=>{ const t=tasks.find(x=>x.id===b.dataset.id); if(t) openTaskModal(t); })); }

function renderChart(){ const canvas=$("#chart"); const ctx=canvas.getContext("2d"); const dpr=window.devicePixelRatio||1; const w=canvas.clientWidth, h=canvas.clientHeight; canvas.width=w*dpr; canvas.height=h*dpr; ctx.scale(dpr,dpr); ctx.clearRect(0,0,w,h); const {y,m}=currentYM(); const first=startOfMonth(y,m); const firstMon=addDays(first,-((first.getDay()+6)%7)); const weeks=Array.from({length:6},(_,i)=>addDays(firstMon,i*7)); const planned=weeks.map(ws=>tasks.filter(t=>{ const d=fromYMD(t.dueDate); return d && d>=ws && d<=addDays(ws,6) && (d.getMonth()+1)===m && d.getFullYear()===y; }).length); const completed=weeks.map(ws=>tasks.filter(t=>{ const d=fromYMD(t.dueDate); return d && d>=ws && d<=addDays(ws,6) && (d.getMonth()+1)===m && d.getFullYear()===y && t.status==="Done"; }).length); const maxY=Math.max(5,...planned,...completed); const pad={l:40,r:12,t:10,b:28}; const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b; const barW=plotW/(weeks.length*2+(weeks.length+1)); const gap=barW; ctx.strokeStyle="#3a3a55"; ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+plotH); ctx.lineTo(pad.l+plotW,pad.t+plotH); ctx.stroke(); ctx.fillStyle="#a3a3b2"; ctx.font="12px system-ui"; for(let yk=0; yk<=maxY; yk+=Math.ceil(maxY/5)){ const yp=pad.t+plotH-(yk/maxY)*plotH; ctx.fillText(String(yk), pad.l-24, yp+4); ctx.globalAlpha=.12; ctx.beginPath(); ctx.moveTo(pad.l,yp); ctx.lineTo(pad.l+plotW,yp); ctx.stroke(); ctx.globalAlpha=1; } weeks.forEach((ws,i)=>{ const x0=pad.l+gap+i*(2*barW+gap); const ph=(planned[i]/maxY)*plotH; ctx.fillStyle="#6ea8fe"; ctx.fillRect(x0, pad.t+plotH-ph, barW, ph); const ch=(completed[i]/maxY)*plotH; ctx.fillStyle="#7bd389"; ctx.fillRect(x0+barW, pad.t+plotH-ch, barW, ch); ctx.fillStyle="#a3a3b2"; const label=String(ws.getMonth()+1).padStart(2,'0')+"/"+String(ws.getDate()).padStart(2,'0'); ctx.fillText(label, x0, pad.t+plotH+16); }); }

function renderBurndown(){ const canvas=$("#burndown"); const ctx=canvas.getContext("2d"); const dpr=window.devicePixelRatio||1; const w=canvas.clientWidth, h=canvas.clientHeight; canvas.width=w*dpr; canvas.height=h*dpr; ctx.scale(dpr,dpr); ctx.clearRect(0,0,w,h); const {y,m}=currentYM(); const first=startOfMonth(y,m), last=endOfMonth(y,m); const days=[]; let d=first; while(d<=last){ days.push(new Date(d)); d=addDays(d,1); } const total=tasksForMonth().reduce((a,t)=>a+(Number(t.hours)||0),0); let rem=total; const actual=days.map(day=>{ const ds=toYMD(day); const delta=tasks.filter(t=>{ const c=t.completedOn?fromYMD(t.completedOn):null; if(c) return toYMD(c)===ds; return t.status==="Done" && t.dueDate===ds; }).reduce((s,t)=>s+(Number(t.actualHours)||Number(t.hours)||0),0); rem=Math.max(0,rem-delta); return rem; }); const ideal=days.map((_,i)=> total*(1 - i/(Math.max(1,days.length-1)))); const maxY=Math.max(5,...actual,...ideal); const pad={l:44,r:12,t:10,b:28}; const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b; const x=i=>pad.l+(i/(days.length-1))*plotW; const yScale=v=>pad.t+plotH-(v/maxY)*plotH; ctx.strokeStyle="#3a3a55"; ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+plotH); ctx.lineTo(pad.l+plotW,pad.t+plotH); ctx.stroke(); ctx.fillStyle="#a3a3b2"; ctx.font="12px system-ui"; const yStep=Math.ceil(maxY/5); for(let k=0;k<=maxY;k+=yStep){ const yp=yScale(k); ctx.fillText(String(Math.round(k)), pad.l-30, yp+4); ctx.globalAlpha=.12; ctx.beginPath(); ctx.moveTo(pad.l,yp); ctx.lineTo(pad.l+plotW,yp); ctx.stroke(); ctx.globalAlpha=1; } ctx.strokeStyle="#a3a3b2"; ctx.beginPath(); ctx.moveTo(x(0), yScale(ideal[0]||0)); for(let i=1;i<days.length;i++){ ctx.lineTo(x(i), yScale(ideal[i]||0)); } ctx.stroke(); ctx.strokeStyle="#6ea8fe"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x(0), yScale(actual[0]||0)); for(let i=1;i<days.length;i++){ ctx.lineTo(x(i), yScale(actual[i]||0)); } ctx.stroke(); }

function importJSON(e){ const f=e.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(Array.isArray(data)){ tasks=data; saveTasks(); renderAll(); } else alert("Invalid file"); } catch(err){ alert("Invalid JSON"); } }; reader.readAsText(f); }
function exportJSON(){ const blob=new Blob([JSON.stringify(tasks,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="proplanner_tasks.json"; a.click(); URL.revokeObjectURL(url); }
function escapeCsv(s){ const str=String(s??""); if(/[",\n]/.test(str)) return '"'+str.replace(/"/g,'""')+'"'; return str; }
function exportCSV(){ const headers=["Task ID","Task Name","Category","Priority","Owner","Start Date","Due Date","Status","Planned Hours","Actual Hours","Completed On","Reminder","Tags","Notes"]; const rows=tasks.map(t=>[t.id,t.title,t.category,t.priority,t.owner,t.startDate,t.dueDate,t.status,t.hours,t.actualHours,t.completedOn,(t.remType==="at"&&t.remAt?("at "+t.remAt):(t.remType==="mins"&&t.remMins?("-"+t.remMins+"m"):"")),t.tags,(t.notes||"").replace(/\n/g," ")]); const csv=[headers.join(","),...rows.map(r=>r.map(escapeCsv).join(","))].join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="proplanner_tasks.csv"; a.click(); URL.revokeObjectURL(url); }

function icsEscape(s){ return String(s||"").replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n"); }
function fmtNow(){ const d=new Date(); return d.getUTCFullYear()+String(d.getUTCMonth()+1).padStart(2,"0")+String(d.getUTCDate()).padStart(2,"0")+"T"+String(d.getUTCHours()).padStart(2,"0")+String(d.getUTCMinutes()).padStart(2,"0")+String(d.getUTCSeconds()).padStart(2,"0")+"Z"; }
function fmtICS(d, hhmmss){ const z=new Date(d); if(hhmmss) return z.getFullYear()+String(z.getMonth()+1).padStart(2,"0")+String(z.getDate()).padStart(2,"0")+"T"+hhmmss; return z.getFullYear()+String(z.getMonth()+1).padStart(2,"0")+String(z.getDate()).padStart(2,"0")+"T"+String(z.getHours()).padStart(2,"0")+String(z.getMinutes()).padStart(2,"0")+String(z.getSeconds()).padStart(2,"0"); }
function exportICS(){ const {y,m}=currentYM(); const arr=tasksForMonth(); if(!arr.length){ alert("No tasks in selected month."); return; } const lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//ProPlanner//EN"]; for(const t of arr){ const dt=fromYMD(t.dueDate)||new Date(); const dtstart=fmtICS(dt,"090000"); const dtend=fmtICS(dt,"100000"); lines.push("BEGIN:VEVENT"); lines.push("UID:"+t.id+"@proplanner"); lines.push("DTSTAMP:"+fmtNow()); lines.push("SUMMARY:"+icsEscape(t.title||"Task")); lines.push("DESCRIPTION:"+icsEscape((t.notes||""))); lines.push("DTSTART:"+dtstart); lines.push("DTEND:"+dtend); let trigger=null; if(t.remType==="mins"&&t.remMins>0) trigger="-PT"+t.remMins+"M"; else if(t.remType==="at"&&t.remAt){ lines.push("BEGIN:VALARM"); lines.push("TRIGGER;VALUE=DATE-TIME:"+fmtICS(new Date(t.remAt))); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM"); } else trigger="-PT10M"; if(trigger){ lines.push("BEGIN:VALARM"); lines.push("TRIGGER:"+trigger); lines.push("ACTION:DISPLAY"); lines.push("DESCRIPTION:Reminder"); lines.push("END:VALARM"); } lines.push("END:VEVENT"); } lines.push("END:VCALENDAR"); const blob=new Blob([lines.join("\r\n")],{type:"text/calendar"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`proplanner_${y}-${String(m).padStart(2,"0")}.ics`; a.click(); URL.revokeObjectURL(url); }

let timers=[];
async function ensureNotifPerm(){ if(!("Notification" in window)) return false; if(Notification.permission==="granted") return true; if(Notification.permission==="denied") return false; const res=await Notification.requestPermission(); return res==="granted"; }
function scheduleUpcomingReminders(){ timers.forEach(t=>clearTimeout(t)); timers=[]; const now=Date.now(); const horizon=now+24*60*60*1000; tasks.forEach(t=>{ let when=null; if(t.remType==="at"&&t.remAt) when=new Date(t.remAt).getTime(); else if(t.remType==="mins"&&t.remMins>0&&t.dueDate) when=fromYMD(t.dueDate).getTime()-t.remMins*60*1000; if(when && when>now && when<horizon){ const delay=when-now; timers.push(setTimeout(async ()=>{ if(await ensureNotifPerm()){ new Notification("Upcoming: "+t.title,{ body:(t.dueDate||""), icon:"./icon-192.png", badge:"./icon-192.png"}); } }, delay)); } }); }

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[s])); }

renderAll();
</script>
</body>
</html>
